{%- assign fields = site.data.config-search -%}
{%- assign index_fields = fields | where: 'index','true' -%}
<script src="{{ '/assets/lib/papaparse.min.js' | relative_url }}"></script>
<script src="{{ '/assets/lib/lunr.min.js' | relative_url }}"></script>
<script>

/* search function */
function lunr_search () {
  var resultdiv = $('#lunrResults');
  var query = $('#lunrSearchBox').val();
  /* basic search that supports operators */
  var result = idx.search(query); 
  resultdiv.empty();
  resultdiv.prepend('<tr><td><h4 class="mt-3">' + result.length + ' Result(s) found</h4></td></tr>');
  for (var item in result) {
    var ref = result[item].ref;
    var searchitem =
      '<tr>'+
          '<td class="">' +
            {% assign display = fields | where: 'display','true' %}
            {% for d in display %}
            {% if forloop.first %}
            '<p class="h4"><a href="{{ site.baseurl }}/item.html?id=' + store[ref].objectid + '">' + store[ref][{{ fields[0].field | jsonify }}]  + '</a></p>' +
            '<p class="ml-3">';
              {% else %}
              if(store[ref][{{ d.field | jsonify }}]) {
                searchitem += store[ref][{{ d.field | jsonify }}] + '<br> '; }
              {% endif %}{% endfor %}
              searchitem += '</p></td>' +
      '</tr>';
    resultdiv.append(searchitem);
  }
};

/* function to set up lunr store */
function createIndex(store) {
  /* initialize lunr */
  idx = lunr(function () {
    /* add index fields from config */
    this.ref('id')
    {% for f in index_fields %}
    this.field({{ f.field | jsonify }})
    {% endfor %}

    for (var item in store) {
      this.add({
        {% for f in index_fields %}
        {{ f.field | jsonify }}: store[item][{{ f.field | jsonify }}],
        {% endfor %}
        id: item
      })
    }
  });

}


/* page init function */
function searchInit(results) {
  // set up item store
  store = results.data;
  for (var item in store) {
    {% for f in index_fields %}
    if(store[item][{{ f.field | jsonify }}] == '') { store[item][{{ f.field | jsonify }}] = "none"; }
    {% endfor %}
  }
  // set up lunr store
  createIndex(store);
  // get query from url if there
  if (window.location.search) {
    var queryString = decodeURIComponent(window.location.search.substring(1).split("=")[1]);
    $('#lunrSearchBox').val(queryString);
    lunr_search ();
  }

}

/* varibles for page */
var idx;
var store = [];
/* use papaparse to get metadata from google sheets, then init page */
Papa.parse("{{ site.metadata-csv-link }}", {
  download: true,
  header: true,
  complete: (results) => searchInit(results)
});

</script>